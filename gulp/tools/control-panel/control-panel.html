<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control Panel - Gulp Project Manager</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    #app { display: flex; height: 100vh; overflow: hidden; }
    
    /* Sidebar */
    .sidebar { width: 280px; background: #1e1e1e; color: #fff; overflow-y: auto; }
    .sidebar-header { padding: 20px; border-bottom: 1px solid #333; }
    .sidebar-header h1 { font-size: 18px; margin-bottom: 10px; }
    .sidebar-section { padding: 15px 20px; border-bottom: 1px solid #333; }
    .sidebar-section h3 { font-size: 14px; margin-bottom: 10px; color: #888; text-transform: uppercase; }
    
    /* Pages List */
    .pages-list { list-style: none; }
    .page-item { padding: 8px 12px; cursor: pointer; border-radius: 4px; margin-bottom: 4px; }
    .page-item:hover { background: #333; }
    .page-item.active { background: #007bff; }
    
    /* Top Bar */
    .topbar { height: 60px; background: #2d2d2d; border-bottom: 1px solid #333; display: flex; align-items: center; padding: 0 20px; }
    .viewport-switcher { display: flex; gap: 10px; }
    .viewport-btn { padding: 8px 16px; background: #444; border: none; color: #fff; cursor: pointer; border-radius: 4px; }
    .viewport-btn.active { background: #007bff; }
    
    /* Main Content */
    .main-content { flex: 1; display: flex; flex-direction: column; }
    .preview-container { flex: 1; position: relative; background: #fff; }
    #preview-frame { width: 100%; height: 100%; border: none; }
    
    /* Constructor Panel */
    .constructor-panel { width: 320px; background: #252526; color: #fff; overflow-y: auto; border-left: 1px solid #333; }
    .panel-section { padding: 20px; border-bottom: 1px solid #333; }
    .panel-section h3 { font-size: 14px; margin-bottom: 15px; color: #888; text-transform: uppercase; }
    
    /* Form Controls */
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-size: 12px; color: #ccc; }
    .form-group input, .form-group select { width: 100%; padding: 8px; background: #3c3c3c; border: 1px solid #555; color: #fff; border-radius: 4px; }
    .form-group input[type="color"] { height: 40px; cursor: pointer; }
    
    .library-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #3c3c3c; border-radius: 4px; margin-bottom: 8px; }
    .library-item input[type="checkbox"] { cursor: pointer; }
    
    .btn { padding: 10px 20px; background: #007bff; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    .btn:hover { background: #0056b3; }
    .btn:disabled { background: #555; cursor: not-allowed; }
    
    .loading { opacity: 0.5; pointer-events: none; }
    .message { padding: 10px; margin: 10px 0; border-radius: 4px; position: fixed; top: 20px; right: 20px; z-index: 10000; min-width: 300px; }
    .message.success { background: #28a745; color: #fff; }
    .message.error { background: #dc3545; color: #fff; }
  </style>
</head>
<body>
  <div id="app">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h1>üé® Control Panel</h1>
        <p style="font-size: 12px; color: #888;">Gulp Project Manager</p>
      </div>
      
      <div class="sidebar-section">
        <h3>üìÑ –°—Ç—Ä–∞–Ω–∏—Ü—ã</h3>
        <ul class="pages-list" id="pages-list">
          <li class="page-item">–ó–∞–≥—Ä—É–∑–∫–∞...</li>
        </ul>
      </div>
      
      <div class="sidebar-section">
        <h3>üß© –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</h3>
        <div class="form-group">
          <input type="text" id="component-name" placeholder="–ò–º—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞" style="margin-bottom: 10px;">
          <select id="component-snippet" style="margin-bottom: 10px;">
            <option value="">–ë–∞–∑–æ–≤—ã–π</option>
            <option value="button">–ö–Ω–æ–ø–∫–∞</option>
            <option value="card">–ö–∞—Ä—Ç–æ—á–∫–∞</option>
            <option value="header">Header</option>
            <option value="footer">Footer</option>
            <option value="navbar">Navbar</option>
          </select>
          <button class="btn" onclick="createComponent()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç</button>
        </div>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
      <div class="topbar">
        <div class="viewport-switcher">
          <button class="viewport-btn" data-device="mobile" onclick="setViewport('mobile')">üì± Mobile (375px)</button>
          <button class="viewport-btn" data-device="tablet" onclick="setViewport('tablet')">üì± Tablet (768px)</button>
          <button class="viewport-btn active" data-device="desktop" onclick="setViewport('desktop')">üíª Desktop (1440px)</button>
        </div>
        <div style="margin-left: auto; display: flex; gap: 10px;">
          <button class="btn" onclick="loadConfig()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>
      
      <div class="preview-container">
        <iframe id="preview-frame" src="/index.html"></iframe>
      </div>
    </div>
    
    <!-- Constructor Panel -->
    <div class="constructor-panel">
      <div class="panel-section">
        <h3>üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏</h3>
        <div id="libraries-list"></div>
      </div>
      
      <div class="panel-section">
        <h3>üé® –¶–≤–µ—Ç–∞</h3>
        <div class="form-group">
          <label>Primary</label>
          <input type="color" id="color-primary" onchange="updateColor('primary', this.value)">
        </div>
        <div class="form-group">
          <label>Secondary</label>
          <input type="color" id="color-secondary" onchange="updateColor('secondary', this.value)">
        </div>
        <div class="form-group">
          <label>Gray</label>
          <input type="color" id="color-gray" onchange="updateColor('gray', this.value)">
        </div>
        <div class="form-group">
          <label>Background</label>
          <input type="color" id="color-background" onchange="updateColor('background', this.value)">
        </div>
        <button class="btn" onclick="saveColors()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–≤–µ—Ç–∞</button>
      </div>
      
      <div class="panel-section">
        <h3>üî§ –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞</h3>
        <div class="form-group">
          <label>Google Font</label>
          <select id="font-select" onchange="updateFont(this.value)">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —à—Ä–∏—Ñ—Ç...</option>
          </select>
        </div>
        <button class="btn" onclick="loadFonts()">–ó–∞–≥—Ä—É–∑–∏—Ç—å Google Fonts</button>
      </div>
    </div>
  </div>
  
  <script>
    const API_URL = '/api';
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
    async function loadPages() {
      try {
        const res = await fetch(`${API_URL}/pages`);
        const data = await res.json();
        const list = document.getElementById('pages-list');
        list.innerHTML = '';
        
        // –î–æ–±–∞–≤–ª—è–µ–º control-panel –∫–∞–∫ –ø–µ—Ä–≤—É—é –æ–ø—Ü–∏—é (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - –º–æ–∂–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–∞–º —Å–µ–±—è)
        const controlPanelItem = document.createElement('li');
        controlPanelItem.className = 'page-item';
        controlPanelItem.textContent = 'control-panel';
        controlPanelItem.onclick = () => {
          loadPage('/control-panel.html');
          document.querySelectorAll('.page-item').forEach(item => item.classList.remove('active'));
          controlPanelItem.classList.add('active');
        };
        list.appendChild(controlPanelItem);
        
        if (!data.pages || data.pages.length === 0) {
          if (list.children.length === 1) {
            list.innerHTML += '<li class="page-item" style="color: #888; cursor: default;">–°—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</li>';
          }
          return;
        }
        
        data.pages.forEach(page => {
          const li = document.createElement('li');
          li.className = 'page-item';
          li.textContent = page.name || page.path || page;
          li.onclick = () => {
            const url = page.url || `/${page.path || page}`;
            loadPage(url);
            document.querySelectorAll('.page-item').forEach(item => item.classList.remove('active'));
            li.classList.add('active');
          };
          list.appendChild(li);
        });
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ–µ–∫—Ç–∞ (–Ω–µ control-panel)
        if (data.pages.length > 0) {
          const firstPage = data.pages[0];
          loadPage(firstPage.url || `/${firstPage.path || firstPage}`);
          // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ–µ–∫—Ç–∞ (–Ω–µ control-panel)
          Array.from(list.children).slice(1)[0]?.classList.add('active');
        } else {
          // –ï—Å–ª–∏ –Ω–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü –ø—Ä–æ–µ–∫—Ç–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º control-panel —Å–∞–º —Å–µ–±—è
          loadPage('/control-panel.html');
          list.firstChild.classList.add('active');
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü:', err);
        showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü: ' + err.message, 'error');
      }
    }
    
    function loadPage(url) {
      document.getElementById('preview-frame').src = url;
    }
    
    // Viewport switching
    async function setViewport(device) {
      try {
        const res = await fetch(`${API_URL}/viewport`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ device })
        });
        
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è viewport');
        
        document.querySelectorAll('.viewport-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        const btn = document.querySelector(`[data-device="${device}"]`);
        if (btn) btn.classList.add('active');
        
        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ iframe
        const frame = document.getElementById('preview-frame');
        const sizes = {
          mobile: { width: '375px', height: '667px' },
          tablet: { width: '768px', height: '1024px' },
          desktop: { width: '100%', height: '100%' }
        };
        Object.assign(frame.style, sizes[device]);
        frame.style.margin = '0 auto';
        frame.style.display = 'block';
        
        showMessage(`Viewport –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ ${device}`, 'success');
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è viewport:', err);
        showMessage('–û—à–∏–±–∫–∞: ' + err.message, 'error');
      }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    async function loadConfig() {
      try {
        const res = await fetch(`${API_URL}/config`);
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏');
        const config = await res.json();
        
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–≤–µ—Ç–æ–≤
        if (config.colors) {
          document.getElementById('color-primary').value = config.colors.primary || '#007bff';
          document.getElementById('color-secondary').value = config.colors.secondary || '#6c757d';
          document.getElementById('color-gray').value = config.colors.gray || '#adb5bd';
          document.getElementById('color-background').value = config.colors.background || '#ffffff';
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫
        if (config.libraries) {
          loadLibraries(config.libraries);
        }
        
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ viewport
        const currentDevice = config.device || 'desktop';
        document.querySelectorAll('.viewport-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        const currentBtn = document.querySelector(`[data-device="${currentDevice}"]`);
        if (currentBtn) currentBtn.classList.add('active');
        
        showMessage('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:', err);
        showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: ' + err.message, 'error');
      }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫
    function loadLibraries(libraries) {
      const libs = {
        bootstrap: 'Bootstrap',
        fontAwesome: 'Font Awesome',
        swiper: 'Swiper',
        jquery: 'jQuery',
        gsap: 'GSAP'
      };
      
      const container = document.getElementById('libraries-list');
      container.innerHTML = '';
      
      Object.entries(libs).forEach(([key, name]) => {
        const div = document.createElement('div');
        div.className = 'library-item';
        div.innerHTML = `
          <label style="cursor: pointer;">
            <input type="checkbox" ${libraries[key] ? 'checked' : ''} onchange="toggleLibrary('${key}', this.checked)">
            ${name}
          </label>
        `;
        container.appendChild(div);
      });
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
    async function toggleLibrary(name, enabled) {
      try {
        const action = enabled ? 'install' : 'uninstall';
        const res = await fetch(`${API_URL}/library/${name}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action })
        });
        
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏');
        
        const data = await res.json();
        showMessage(data.message || `–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ ${name} ${enabled ? '—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞' : '—É–¥–∞–ª–µ–Ω–∞'}`, 'success');
      } catch (err) {
        showMessage('–û—à–∏–±–∫–∞: ' + err.message, 'error');
      }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞
    function updateColor(name, value) {
      // Live preview –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–¥–µ—Å—å
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤
    async function saveColors() {
      try {
        const colors = {
          primary: document.getElementById('color-primary').value,
          secondary: document.getElementById('color-secondary').value,
          gray: document.getElementById('color-gray').value,
          background: document.getElementById('color-background').value
        };
        
        const res = await fetch(`${API_URL}/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ colors })
        });
        
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        
        showMessage('–¶–≤–µ—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–±–æ—Ä–∫—É.', 'success');
      } catch (err) {
        showMessage('–û—à–∏–±–∫–∞: ' + err.message, 'error');
      }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ Google Fonts
    async function loadFonts() {
      try {
        const res = await fetch(`${API_URL}/fonts`);
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à—Ä–∏—Ñ—Ç–æ–≤');
        
        const data = await res.json();
        const select = document.getElementById('font-select');
        
        // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —à—Ä–∏—Ñ—Ç...</option>';
        
        if (data.fonts && data.fonts.length > 0) {
          data.fonts.slice(0, 50).forEach(font => {
            const option = document.createElement('option');
            option.value = font.family || font;
            option.textContent = font.family || font;
            select.appendChild(option);
          });
          showMessage('Google Fonts –∑–∞–≥—Ä—É–∂–µ–Ω—ã!', 'success');
        }
      } catch (err) {
        showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à—Ä–∏—Ñ—Ç–æ–≤: ' + err.message, 'error');
      }
    }
    
    async function updateFont(fontFamily) {
      if (!fontFamily) return;
      
      try {
        const res = await fetch(`${API_URL}/font`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fontFamily })
        });
        
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —à—Ä–∏—Ñ—Ç–∞');
        
        const data = await res.json();
        showMessage(data.message || `–®—Ä–∏—Ñ—Ç ${fontFamily} —Å–æ—Ö—Ä–∞–Ω–µ–Ω`, 'success');
      } catch (err) {
        showMessage('–û—à–∏–±–∫–∞: ' + err.message, 'error');
      }
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    async function createComponent() {
      const blockName = document.getElementById('component-name').value;
      const snippetType = document.getElementById('component-snippet').value;
      
      if (!blockName) {
        showMessage('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞', 'error');
        return;
      }
      
      try {
        const res = await fetch(`${API_URL}/component`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ blockName, snippetType })
        });
        
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞');
        
        const data = await res.json();
        showMessage(data.message || '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω!', 'success');
        document.getElementById('component-name').value = '';
      } catch (err) {
        showMessage('–û—à–∏–±–∫–∞: ' + err.message, 'error');
      }
    }
    
    function showMessage(text, type) {
      const msg = document.createElement('div');
      msg.className = `message ${type}`;
      msg.textContent = text;
      document.body.appendChild(msg);
      setTimeout(() => msg.remove(), 3000);
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    loadPages();
    loadConfig();
  </script>
</body>
</html>

